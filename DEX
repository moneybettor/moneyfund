<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <title>MoneyFund DEX</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0A0C1E, #1F2A44);
            color: #E5E7EB;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 17.94px; /* 20px * 0.65 * 1.15 */
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" opacity="0.03"%3E%3Cdefs%3E%3Cfilter id="noise"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.7" numOctaves="4" stitchTiles="stitch"/%3E%3C/filter%3E%3C/defs%3E%3Crect width="100%" height="100%" filter="url(%23noise)"/%3E%3C/svg%3E');
            z-index: -1;
        }

        .app-container {
            width: 100%;
            max-width: 1320px; /* 1100px * 1.2 */
            margin: 17.94px; /* 20px * 0.65 * 1.15 */
            text-align: center;
            position: relative;
        }

        .app-container h1 {
            font-size: 2.154rem; /* 1.794rem * 1.2 */
            color: #FFFFFF;
            margin: 0 0 17.94px; /* 20px * 0.65 * 1.15 */
            padding: 0;
        }

        .wallet-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8.97px; /* 10px * 0.65 * 1.15 */
            margin-bottom: 21.53px; /* 20px * 0.65 * 1.15 * 1.2 */
        }

        .section {
            background: rgba(31, 41, 55, 0.6);
            padding: 32.29px; /* 26.91px * 1.2 */
            margin-bottom: 21.53px; /* 17.94px * 1.2 */
            border-radius: 14.35px; /* 11.96px * 1.2 */
            backdrop-filter: blur(14.35px); /* 11.96px * 1.2 */
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 5.382px 17.94px rgba(0, 0, 0, 0.2); /* 4.485px, 14.95px * 1.2 */
        }

        .section h2, .expandable-content h3 {
            margin: 0 auto 14.35px; /* 11.96px * 1.2 */
            color: #FFFFFF;
            font-size: 1.6164rem; /* 1.347rem * 1.2 */
            border-bottom: 2px solid #6366F1;
            padding-bottom: 7.18px; /* 5.98px * 1.2 */
            display: inline-block;
        }

        button {
            background: linear-gradient(90deg, #4F46E5, #A855F7);
            color: #F9FAFB;
            border: none;
            padding: 14.35px 17.94px; /* 11.96px, 14.95px * 1.2 */
            margin: 3.588px; /* 2.99px * 1.2 */
            border-radius: 8.97px; /* 7.475px * 1.2 */
            cursor: pointer;
            font-size: 0.8611rem; /* 0.7176rem * 1.2 */
            transition: background 0.25s ease, transform 0.2s, box-shadow 0.3s;
            white-space: nowrap;
        }

        button:hover {
            background: linear-gradient(90deg, #4338CA, #9333EA);
            transform: scale(1.02);
            box-shadow: 0 5.382px 14.35px rgba(99, 102, 241, 0.4); /* 4.485px, 11.96px * 1.2 */
        }

        button:disabled {
            background: rgba(75, 85, 99, 0.6);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.loading {
            background: rgba(75, 85, 99, 0.6);
            cursor: not-allowed;
            position: relative;
        }

        button.loading::after {
            content: '';
            display: inline-block;
            width: 12.56px; /* 10.465px * 1.2 */
            height: 12.56px; /* 10.465px * 1.2 */
            border: 2px solid #F9FAFB;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 5.382px; /* 4.485px * 1.2 */
        }

        button i {
            margin-right: 3.588px; /* 2.99px * 1.2 */
        }

        input, select {
            padding: 14.35px; /* 11.96px * 1.2 */
            margin: 5.382px; /* 4.485px * 1.2 */
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8.97px; /* 7.475px * 1.2 */
            background: rgba(17, 24, 39, 0.9);
            color: #E5E7EB;
            font-size: 1.0764rem; /* 0.897rem * 1.2 */
            width: 100%;
            max-width: 480px; /* 400px * 1.2 */
            transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.3s;
            text-align: left;
            box-shadow: inset 0 1.794px 5.382px rgba(0, 0, 0, 0.15); /* 1.495px, 4.485px * 1.2 */
        }

        input:hover, select:hover {
            background: rgba(17, 24, 39, 0.95);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 0 7.18px rgba(99, 102, 241, 0.3); /* 5.98px * 1.2 */
        }

        input:focus, select:focus, button:focus {
            outline: none;
            border-color: #6366F1;
            box-shadow: 0 0 8.97px rgba(99, 102, 241, 0.5); /* 7.475px * 1.2 */
            background: rgba(17, 24, 39, 0.95);
        }

        input::placeholder {
            color: #9CA3AF;
            text-align: left;
            opacity: 0.8;
        }

        .info-container {
            display: flex;
            justify-content: center;
            gap: 32.29px; /* 26.91px * 1.2 */
            margin-top: 14.35px; /* 11.96px * 1.2 */
        }

        .info-half {
            flex: 1;
            background: rgba(17, 24, 39, 0.9);
            padding: 21.53px; /* 17.94px * 1.2 */
            border-radius: 5.382px; /* 4.485px * 1.2 */
            font-size: 0.9688rem; /* 0.8073rem * 1.2 */
            line-height: 1.5;
            border: 1px solid rgba(99, 102, 241, 0.15);
            text-align: center;
            max-width: 600px; /* 500px * 1.2 */
        }

        .info-half hr {
            border: 0;
            border-top: 1px solid rgba(99, 102, 241, 0.15);
            margin: 7.18px auto; /* 5.98px * 1.2 */
            width: 80%;
        }

        .action-group {
            display: flex;
            flex-direction: column;
            gap: 14.35px; /* 11.96px * 1.2 */
            justify-content: center;
            align-items: center;
            background: rgba(17, 24, 39, 0.9);
            padding: 14.35px; /* 11.96px * 1.2 */
            border-radius: 8.97px; /* 7.475px * 1.2 */
        }

        #connectMetaMaskBtn {
            padding: 14.35px; /* 11.96px * 1.2 */
            font-size: 0.8611rem; /* 0.7176rem * 1.2 */
            width: auto;
            height: 50.18px; /* 41.82px * 1.2 */
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 7.18px; /* 5.98px * 1.2 */
            position: relative;
        }

        .input-group label {
            font-size: 0.9688rem; /* 0.8073rem * 1.2 */
            color: #E5E7EB;
        }

        .input-group label::after {
            content: '?';
            display: inline-block;
            margin-left: 5.382px; /* 4.485px * 1.2 */
            width: 14.35px; /* 11.96px * 1.2 */
            height: 14.35px; /* 11.96px * 1.2 */
            line-height: 14.35px;
            text-align: center;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.2);
            cursor: help;
        }

        .input-group label:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            top: -32.29px; /* -26.91px * 1.2 */
            left: 50%;
            transform: translateX(-50%);
            padding: 7.18px 10.76px; /* 5.98px, 8.97px * 1.2 */
            background: rgba(17, 24, 39, 0.9);
            color: #E5E7EB;
            border-radius: 5.382px; /* 4.485px * 1.2 */
            font-size: 0.7535rem; /* 0.6279rem * 1.2 */
            white-space: nowrap;
            z-index: 10;
            max-width: 300px; /* 250px * 1.2 */
            text-align: center;
        }

        .expandable-content {
            padding: 21.53px; /* 17.94px * 1.2 */
            background: rgba(17, 24, 39, 0.9);
            border-radius: 8.97px; /* 7.475px * 1.2 */
            border: 1px solid rgba(99, 102, 241, 0.15);
            display: none;
            width: 100%;
            max-width: 600px; /* 500px * 1.2 */
        }

        .expandable-content.active {
            display: block;
        }

        .expandable-content.pairs {
            max-height: 161.46px; /* 134.55px * 1.2 */
            overflow-y: auto;
            font-size: 0.8611rem; /* 0.7176rem * 1.2 */
        }

        .pair-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3.588px 7.18px; /* 2.99px, 5.98px * 1.2 */
        }

        .pair-item button {
            padding: 7.18px 10.76px; /* 5.98px, 8.97px * 1.2 */
            font-size: 0.8611rem; /* 0.7176rem * 1.2 */
        }

        .pair-item div {
            text-align: left;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pair-item hr {
            border: 0;
            border-top: 1px solid rgba(99, 102, 241, 0.15);
            margin: 3.588px 0; /* 2.99px * 1.2 */
        }

        .button-group {
            display: flex;
            gap: 8.97px; /* 7.475px * 1.2 */
            flex-wrap: nowrap;
            justify-content: center;
            margin: 14.35px 0; /* 11.96px * 1.2 */
        }

        .status-box {
            position: fixed;
            top: 14.35px; /* 11.96px * 1.2 */
            right: 14.35px; /* 11.96px * 1.2 */
            background: rgba(31, 41, 55, 0.6);
            padding: 7.18px 14.35px; /* 5.98px, 11.96px * 1.2 */
            border-radius: 7.18px; /* 5.98px * 1.2 */
            backdrop-filter: blur(14.35px); /* 11.96px * 1.2 */
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 5.382px 14.35px rgba(0, 0, 0, 0.2); /* 4.485px, 11.96px * 1.2 */
            display: none;
            z-index: 1000;
            color: #E5E7EB;
            max-width: 360px; /* 300px * 1.2 */
            text-align: left;
            font-size: 0.8611rem; /* 0.7176rem * 1.2 */
            transition: opacity 0.3s ease;
        }

        .status-box.success {
            background: rgba(99, 102, 241, 0.2);
            border-color: #6366F1;
        }

        .status-box.error {
            background: rgba(239, 68, 68, 0.2);
            border-color: #EF4444;
        }

        .status-box .spinner {
            width: 12.56px; /* 10.465px * 1.2 */
            height: 12.56px; /* 10.465px * 1.2 */
            border: 2px solid rgba(99, 102, 241, 0.15);
            border-top: 2px solid #6366F1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5.382px; /* 4.485px * 1.2 */
            vertical-align: middle;
        }

        .status-box .checkmark {
            display: none;
            width: 12.56px; /* 10.465px * 1.2 */
            height: 12.56px; /* 10.465px * 1.2 */
            background-color: #6366F1;
            border-radius: 50%;
            color: #F9FAFB;
            font-size: 8.97px; /* 7.475px * 1.2 */
            line-height: 12.56px;
            text-align: center;
            margin-right: 5.382px; /* 4.485px * 1.2 */
            vertical-align: middle;
        }

        .status-box.success .spinner {
            display: none;
        }

        .status-box.success .checkmark {
            display: inline-block;
        }

        .status-box .close-btn {
            margin-left: 7.18px; /* 5.98px * 1.2 */
            padding: 3.588px 7.18px; /* 2.99px, 5.98px * 1.2 */
            background: rgba(17, 24, 39, 0.9);
            border-radius: 5.382px; /* 4.485px * 1.2 */
            color: #F9FAFB;
            cursor: pointer;
            font-size: 0.7535rem; /* 0.6279rem * 1.2 */
            border: none;
            transition: background 0.25s ease;
        }

        .status-box .retry-btn {
            margin-left: 7.18px; /* 5.98px * 1.2 */
            padding: 3.588px 7.18px; /* 2.99px, 5.98px * 1.2 */
            background: #EF4444;
            border-radius: 5.382px; /* 4.485px * 1.2 */
            color: #F9FAFB;
            cursor: pointer;
            font-size: 0.7535rem; /* 0.6279rem * 1.2 */
            border: none;
            transition: background 0.25s ease;
        }

        .status-box .retry-btn:hover {
            background: #DC2626;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .app-container {
                margin: 8.97px; /* 10px * 0.65 * 1.15 */
            }
            .app-container h1 {
                font-size: 1.722rem; /* 1.794rem * 0.8 * 1.2 */
            }
            .section {
                padding: 21.53px; /* 17.94px * 1.2 */
            }
            button, input, select {
                padding: 10.76px; /* 8.97px * 1.2 */
                font-size: 1.0764rem; /* 0.897rem * 1.2 */
            }
            .info-container {
                flex-direction: column;
                gap: 14.35px; /* 11.96px * 1.2 */
            }
            .wallet-controls {
                flex-direction: column;
                gap: 8.97px; /* 10px * 0.65 * 1.15 */
            }
            #connectMetaMaskBtn {
                width: 100%;
                max-width: 480px; /* 400px * 1.2 */
                height: auto;
            }
            .status-box {
                width: 90%;
                font-size: 0.7535rem; /* 0.6279rem * 1.2 */
                padding: 7.18px 10.76px; /* 5.98px, 8.97px * 1.2 */
                max-width: 300px; /* 250px * 1.2 */
                top: 53.82px; /* 44.85px * 1.2 */
                right: 8.97px; /* 10px * 0.65 * 1.15 */
            }
            .input-group label:hover::before {
                top: -26.91px; /* -22.425px * 1.2 */
                font-size: 0.6458rem; /* 0.5382rem * 1.2 */
                max-width: 240px; /* 200px * 1.2 */
            }
            .expandable-content {
                max-height: 129.17px; /* 107.64px * 1.2 */
                font-size: 0.8611rem; /* 0.7176rem * 1.2 */
                padding: 14.35px; /* 11.96px * 1.2 */
                max-width: 100%;
            }
            .expandable-content.pairs {
                max-height: 129.17px; /* 107.64px * 1.2 */
                overflow-y: auto;
            }
            .pair-item button, .expandable-content button {
                padding: 7.18px 10.76px; /* 5.98px, 8.97px * 1.2 */
                font-size: 0.8611rem; /* 0.7176rem * 1.2 */
            }
            .button-group {
                flex-wrap: wrap;
                gap: 7.18px; /* 5.98px * 1.2 */
                justify-content: center;
            }
            button {
                padding: 10.76px 12.56px; /* 8.97px, 10.465px * 1.2 */
                font-size: 0.8611rem; /* 0.7176rem * 1.2 */
                margin: 3.588px; /* 2.99px * 1.2 */
            }
            button i {
                margin-right: 3.588px; /* 2.99px * 1.2 */
            }
        }
    </style>
</head>

<body>
    <div id="statusBox" class="status-box">
        <span class="spinner" id="statusSpinner"></span>
        <span class="checkmark" id="statusCheckmark">✓</span>
        <span id="statusMessage">Processing...</span>
        <button class="close-btn" id="closeStatusBtn">Close</button>
        <button class="retry-btn" id="retryStatusBtn" style="display: none;">Retry</button>
    </div>
    <div class="app-container">
        <h1>MoneyFund DEX</h1>
        <!-- Wallet Controls -->
        <div class="wallet-controls">
            <select id="walletSelector" onchange="selectWallet(this.value)" aria-label="Select wallet">
                <option value="">-- Select Wallet --</option>
            </select>
            <button id="connectMetaMaskBtn" aria-label="Connect MetaMask wallet"><i class="fas fa-wallet"></i> Connect MetaMask</button>
        </div>

        <!-- Interact with Pair -->
        <div class="section">
            <div class="info-container">
                <div class="info-half" id="totalPairs">Total Pairs: Loading...</div>
                <div class="info-half" id="totalSwaps">Total Swaps: Loading...</div>
            </div>
            <div class="action-group">
                <div class="input-group">
                    <label data-tooltip="Enter the address of the liquidity pair (e.g., 0x...)">Pair Address</label>
                    <input type="text" id="pairAddress" placeholder="Pair Address (e.g., 0x...)" aria-label="Pair contract address">
                </div>
                <div class="button-group">
                    <button onclick="toggleSection('create-pair')"><i class="fas fa-plus"></i> Create New Pair</button>
                    <button onclick="loadPair()"><i class="fas fa-search"></i> Load Pair</button>
                    <button onclick="toggleSection('pairList')"><i class="fas fa-list"></i> See All Pairs</button>
                    <button onclick="toggleSection('add-liquidity')"><i class="fas fa-plus-circle"></i> Add Liquidity</button>
                    <button onclick="toggleSection('remove-liquidity')"><i class="fas fa-minus-circle"></i> Remove Liquidity</button>
                    <button onclick="toggleSection('swap-tokens')"><i class="fas fa-exchange-alt"></i> Swap Tokens</button>
                </div>
                <div id="create-pair" class="expandable-content">
                    <h3>Create New Pair</h3>
                    <div class="action-group">
                        <div class="input-group">
                            <label data-tooltip="Enter the contract address of the first token (e.g., 0x...)">Token 1 Address</label>
                            <input type="text" id="token0" placeholder="Token 1 Address (e.g., 0x...)" aria-label="Token 1 contract address">
                        </div>
                        <div class="input-group">
                            <label data-tooltip="Enter the contract address of the second token (e.g., 0x...)">Token 2 Address</label>
                            <input type="text" id="token1" placeholder="Token 2 Address (e.g., 0x...)" aria-label="Token 2 contract address">
                        </div>
                        <button onclick="createPair()"><i class="fas fa-plus"></i> Create Pair</button>
                    </div>
                </div>
                <div id="pairList" class="expandable-content pairs">Click "See All Pairs" to load pairs.</div>
                <div id="add-liquidity" class="expandable-content">
                    <h3>Add Liquidity</h3>
                    <div class="action-group">
                        <div class="input-group">
                            <label data-tooltip="Amount of the first token to add to the pool">Amount of Token 1</label>
                            <input type="number" id="amount0Add" placeholder="e.g., 10" step="0.000000000000000001" aria-label="Amount of token 1">
                        </div>
                        <div class="input-group">
                            <label data-tooltip="Amount of the second token to add to the pool">Amount of Token 2</label>
                            <input type="number" id="amount1Add" placeholder="e.g., 10" step="0.000000000000000001" aria-label="Amount of token 2">
                        </div>
                        <button onclick="approveAndAddLiquidity()"><i class="fas fa-plus-circle"></i> Approve & Add Liquidity</button>
                    </div>
                </div>
                <div id="remove-liquidity" class="expandable-content">
                    <h3>Remove Liquidity</h3>
                    <div class="action-group">
                        <div class="input-group">
                            <label data-tooltip="Amount of liquidity pool tokens to burn">Amount of LP tokens to burn</label>
                            <input type="number" id="liquidityRemove" placeholder="e.g., 100" step="0.000000000000000001" aria-label="Amount of LP tokens">
                        </div>
                        <button onclick="approveAndRemoveLiquidity()"><i class="fas fa-minus-circle"></i> Remove Liquidity</button>
                    </div>
                </div>
                <div id="swap-tokens" class="expandable-content">
                    <h3>Swap Tokens</h3>
                    <div class="action-group">
                        <div class="input-group">
                            <label data-tooltip="Amount of tokens to swap">Amount to Swap</label>
                            <input type="number" id="swapAmount" placeholder="e.g., 5" step="0.000000000000000001" aria-label="Amount to swap">
                        </div>
                        <div class="input-group">
                            <label data-tooltip="Maximum slippage percentage you're willing to accept (e.g., 5 for 5%)">Slippage Tolerance (%)</label>
                            <input type="number" id="slippageTolerance" placeholder="e.g., 5" step="0.1" min="0.1" max="50" value="5" aria-label="Slippage tolerance percentage">
                        </div>
                        <div class="action-group">
                            <button onclick="approveAndSwap(true)"><i class="fas fa-exchange-alt"></i> Swap Token 1 for Token 2</button>
                            <button onclick="approveAndSwap(false)"><i class="fas fa-exchange-alt"></i> Swap Token 2 for Token 1</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="info-container">
                <div class="info-half" id="pairDetails">Enter a pair address to load details.</div>
            </div>
        </div>
    </div>

    <script>
        // Load ethers.js
        function loadEthers() {
            return new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.src = "https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js";
                script.async = true;
                script.onload = () => resolve(window.ethers);
                script.onerror = () => {
                    const fallback = document.createElement("script");
                    fallback.src = "https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js";
                    fallback.async = true;
                    fallback.onload = () => resolve(window.ethers);
                    fallback.onerror = () => reject(new Error("Both CDNs failed to load ethers.js"));
                    document.head.appendChild(fallback);
                };
                document.head.appendChild(script);
            });
        }

        // Global variables
        let provider, signer, moneyDEXContract, pairContract, token0Contract, token1Contract, web3, userAccount;
        let wallets = [];
        let selectedWallet = null;

        // Hardcoded Values
        const MONEYDEX_ADDRESS = "0x2e24553474be9136785303689c65af45c55f0f55";

        // Updated MoneyDEX ABI
        const MONEYDEX_ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "token0", "type": "address"},
                    {"internalType": "address", "name": "token1", "type": "address"},
                    {"internalType": "uint256", "name": "amount0", "type": "uint256"},
                    {"internalType": "uint256", "name": "amount1", "type": "uint256"}
                ],
                "name": "addLiquidity",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "token0", "type": "address"},
                    {"internalType": "address", "name": "token1", "type": "address"}
                ],
                "name": "createPair",
                "outputs": [{"internalType": "address", "name": "pair", "type": "address"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "initialOwner", "type": "address"}],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [{"internalType": "address", "name": "owner", "type": "address"}],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "sender", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "amount0", "type": "uint256"},
                    {"indexed": false, "internalType": "uint256", "name": "amount1", "type": "uint256"},
                    {"indexed": true, "internalType": "address", "name": "to", "type": "address"}
                ],
                "name": "Burn",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "token", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "DivFeeAdded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "token", "type": "address"},
                    {"indexed": true, "internalType": "address", "name": "pair", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "FeeAdded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "sender", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "amount0", "type": "uint256"},
                    {"indexed": false, "internalType": "uint256", "name": "amount1", "type": "uint256"}
                ],
                "name": "Mint",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "previousOwner", "type": "address"},
                    {"indexed": true, "internalType": "address", "name": "newOwner", "type": "address"}
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "token0", "type": "address"},
                    {"indexed": true, "internalType": "address", "name": "token1", "type": "address"},
                    {"indexed": false, "internalType": "address", "name": "pair", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "pairCount", "type": "uint256"}
                ],
                "name": "PairCreated",
                "type": "event"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "token0", "type": "address"},
                    {"internalType": "address", "name": "token1", "type": "address"},
                    {"internalType": "uint256", "name": "liquidity", "type": "uint256"}
                ],
                "name": "removeLiquidity",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "sender", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "amount0In", "type": "uint256"},
                    {"indexed": false, "internalType": "uint256", "name": "amount1In", "type": "uint256"},
                    {"indexed": false, "internalType": "uint256", "name": "amount0Out", "type": "uint256"},
                    {"indexed": false, "internalType": "uint256", "name": "amount1Out", "type": "uint256"},
                    {"indexed": true, "internalType": "address", "name": "to", "type": "address"}
                ],
                "name": "Swap",
                "type": "event"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "token0", "type": "address"},
                    {"internalType": "address", "name": "token1", "type": "address"},
                    {"internalType": "uint256", "name": "amount0In", "type": "uint256"},
                    {"internalType": "uint256", "name": "minAmount1Out", "type": "uint256"}
                ],
                "name": "swapToken0ForToken1",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "token0", "type": "address"},
                    {"internalType": "address", "name": "token1", "type": "address"},
                    {"internalType": "uint256", "name": "amount1In", "type": "uint256"},
                    {"internalType": "uint256", "name": "minAmount0Out", "type": "uint256"}
                ],
                "name": "swapToken1ForToken0",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "newOwner", "type": "address"}
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "name": "allPairs",
                "outputs": [
                    {"internalType": "address", "name": "", "type": "address"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "DIVIDEND_FEE",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "DIVIDEND_POOL",
                "outputs": [
                    {"internalType": "address", "name": "", "type": "address"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "FEE_DENOMINATOR",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "FEE_PERCENTAGE",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getAllPairs",
                "outputs": [
                    {"internalType": "address[]", "name": "", "type": "address[]"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "", "type": "address"},
                    {"internalType": "address", "name": "", "type": "address"}
                ],
                "name": "getPair",
                "outputs": [
                    {"internalType": "address", "name": "", "type": "address"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "token0", "type": "address"},
                    {"internalType": "address", "name": "token1", "type": "address"}
                ],
                "name": "getReserves",
                "outputs": [
                    {"internalType": "uint256", "name": "reserve0", "type": "uint256"},
                    {"internalType": "uint256", "name": "reserve1", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalSwaps",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "LP_TOKEN_SCALING_FACTOR",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "MINIMUM_LIQUIDITY",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {"internalType": "address", "name": "", "type": "address"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "SPECIAL_FEE_PERCENTAGE",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "SPECIAL_FEE_RECIPIENT",
                "outputs": [
                    {"internalType": "address", "name": "", "type": "address"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalPairs",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSwaps",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // MoneyDEXPair ABI
        const PAIR_ABI = [
            {
                "inputs": [],
                "name": "moneyDEX",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "token0",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "token1",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "reserve0",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "reserve1",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "account", "type": "address"}
                ],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // ERC20 ABI
        const ERC20_ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "spender", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "account", "type": "address"}
                ],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {"name": "owner", "type": "address"},
                    {"name": "spender", "type": "address"}
                ],
                "name": "allowance",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "symbol",
                "outputs": [{"name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "to", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "transfer",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Status Box Functions
        window.showStatusBanner = function(message, isError = false) {
            const box = document.getElementById("statusBox");
            const spinner = document.getElementById("statusSpinner");
            const checkmark = document.getElementById("statusCheckmark");
            const statusMessage = document.getElementById("statusMessage");
            const closeBtn = document.getElementById("closeStatusBtn");
            const retryBtn = document.getElementById("retryStatusBtn");

            box.classList.remove('success', 'error');
            box.classList.add(isError ? 'error' : 'success');
            spinner.style.display = "inline-block";
            checkmark.style.display = "none";
            closeBtn.style.display = "inline-block";
            retryBtn.style.display = isError ? "inline-block" : "none";
            statusMessage.textContent = message;

            box.style.display = "flex";
            setTimeout(() => box.style.opacity = "1", 10);
        };

        window.updateStatusBanner = function({ message, address, success = false, isError = false, txHash = null }) {
            const box = document.getElementById("statusBox");
            const spinner = document.getElementById("statusSpinner");
            const checkmark = document.getElementById("statusCheckmark");
            const statusMessage = document.getElementById("statusMessage");
            const retryBtn = document.getElementById("retryStatusBtn");

            box.classList.remove('success', 'error');
            box.classList.add(isError ? 'error' : 'success');
            statusMessage.textContent = message + (address ? ` (Address: ${address.slice(0, 6)}...${address.slice(-4)})` : '');
            if (txHash) {
                statusMessage.innerHTML += ` <a href="https://etherscan.io/tx/${txHash}" target="_blank" style="color: #6366F1;">View on Etherscan</a>`;
            }
            spinner.style.display = success || isError ? "none" : "inline-block";
            checkmark.style.display = success ? "inline-block" : "none";
            retryBtn.style.display = isError ? "inline-block" : "none";

            if (success || isError) {
                setTimeout(() => {
                    box.style.opacity = "0";
                    setTimeout(() => box.style.display = "none", 300);
                }, 5000);
            }
        };

        window.hideStatusBanner = function() {
            const box = document.getElementById("statusBox");
            box.style.opacity = "0";
            setTimeout(() => box.style.display = "none", 300);
        };

        // Input Validation
        function validateAddress(input) {
            const isValid = ethers.utils.isAddress(input.value);
            input.style.borderColor = isValid ? '#6366F1' : '#EF4444';
            return isValid;
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Fetch and display Total Pairs and Total Swaps
        window.updateStats = async function() {
            if (!moneyDEXContract) {
                document.getElementById("totalPairs").innerHTML = "Total Pairs: Not connected";
                document.getElementById("totalSwaps").innerHTML = "Total Swaps: Not connected";
                return;
            }
            try {
                const totalPairs = await moneyDEXContract.totalPairs();
                const totalSwaps = await moneyDEXContract.getTotalSwaps();
                document.getElementById("totalPairs").innerHTML = `Total Pairs: ${totalPairs.toString()}`;
                document.getElementById("totalSwaps").innerHTML = `Total Swaps: ${totalSwaps.toString()}`;
            } catch (error) {
                console.error("Error fetching stats:", error);
                document.getElementById("totalPairs").innerHTML = "Total Pairs: Error";
                document.getElementById("totalSwaps").innerHTML = "Total Swaps: Error";
            }
        };

        // Toggle Expandable Section
        window.toggleSection = function(sectionId) {
            const section = document.getElementById(sectionId);
            const button = document.querySelector(`button[onclick="toggleSection('${sectionId}')"]`);
            const isActive = section.classList.contains('active');
            section.classList.toggle('active', !isActive);
            button.innerHTML = `<i class="fas fa-${sectionId === 'pairList' ? 'list' : sectionId === 'create-pair' ? 'plus' : sectionId === 'add-liquidity' ? 'plus-circle' : sectionId === 'remove-liquidity' ? 'minus-circle' : 'exchange-alt'}"></i> ${isActive ? sectionId === 'pairList' ? 'See All Pairs' : sectionId === 'create-pair' ? 'Create New Pair' : sectionId === 'add-liquidity' ? 'Add Liquidity' : sectionId === 'remove-liquidity' ? 'Remove Liquidity' : 'Swap Tokens' : sectionId === 'pairList' ? 'Hide Pairs' : sectionId === 'create-pair' ? 'Hide Create Pair' : sectionId === 'add-liquidity' ? 'Hide Add Liquidity' : sectionId === 'remove-liquidity' ? 'Hide Remove Liquidity' : 'Hide Swap Tokens'}`;
            if (sectionId === 'pairList' && !isActive) {
                window.listPairs();
            }
        };

        // Initialize Wallets
        window.initializeWallets = async function() {
            console.log("Initializing wallets...");
            web3 = new Web3(web3 ? web3.currentProvider : "https://mainnet.infura.io/v3/cf2916fb6dbc47ae824d6f36db817b73");
            wallets = JSON.parse(localStorage.getItem('wallets') || '[]');

            if (window.ethereum && userAccount) {
                const metamaskWallet = { address: userAccount, type: 'MetaMask', isMetaMask: true };
                if (!wallets.some(w => w.address === metamaskWallet.address)) {
                    wallets.push(metamaskWallet);
                }
            }

            wallets = wallets.map(wallet => {
                if (wallet.type === 'moneyfund' && wallet.privateKey) {
                    return { ...wallet, isMetaMask: false };
                }
                return wallet;
            });

            localStorage.setItem('wallets', JSON.stringify(wallets));

            const walletSelector = document.getElementById('walletSelector');
            walletSelector.innerHTML = '<option value="">-- Select Wallet --</option>';
            wallets.forEach((wallet, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${wallet.type}: ${wallet.address.slice(0, 6)}...${wallet.address.slice(-4)}`;
                walletSelector.appendChild(option);
            });

            const selectedIndex = parseInt(localStorage.getItem('selectedWalletIndex')) || 0;
            if (wallets.length > 0 && selectedIndex >= 0 && selectedIndex < wallets.length) {
                selectedWallet = wallets[selectedIndex];
                walletSelector.value = selectedIndex;
                await window.selectWallet(selectedIndex);
            } else if (wallets.length > 0) {
                selectedWallet = wallets[0];
                localStorage.setItem('selectedWalletIndex', 0);
                walletSelector.value = 0;
                await window.selectWallet(0);
            }
            updateUIVisibility();
            await window.updateStats();
        };

        // Select Wallet
        window.selectWallet = async function(index) {
            console.log("Selecting wallet with index:", index);
            const idx = parseInt(index);
            if (idx >= 0 && idx < wallets.length) {
                selectedWallet = wallets[idx];
                localStorage.setItem('selectedWalletIndex', idx);
                userAccount = selectedWallet.address;

                if (selectedWallet.isMetaMask && window.ethereum) {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    moneyDEXContract = new ethers.Contract(MONEYDEX_ADDRESS, MONEYDEX_ABI, signer);
                } else {
                    provider = new ethers.providers.JsonRpcProvider("https://mainnet.infura.io/v3/cf2916fb6dbc47ae824d6f36db817b73");
                    const wallet = new ethers.Wallet(selectedWallet.privateKey, provider);
                    signer = wallet;
                    moneyDEXContract = new ethers.Contract(MONEYDEX_ADDRESS, MONEYDEX_ABI, wallet);
                }
                console.log("MoneyDEX contract initialized:", moneyDEXContract.address);
                updateUIVisibility();
                await window.updateStats();
            } else {
                selectedWallet = null;
                userAccount = null;
                moneyDEXContract = null;
                pairContract = null;
                token0Contract = null;
                token1Contract = null;
                await window.updateStats();
            }
            updateUIVisibility();
        };

        // Update UI Visibility
        function updateUIVisibility() {
            const connected = !!userAccount;
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = connected ? 'block' : 'none';
            });
        }

        // Connect MetaMask
        window.connectMetaMask = async function() {
            if (!window.ethereum) {
                window.showStatusBanner("Please install MetaMask!", true);
                return;
            }
            window.showStatusBanner("Connecting MetaMask...");
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await window.ethereum.request({ method: "eth_requestAccounts" });
                const chainId = await provider.getNetwork().then(net => net.chainId);
                if (chainId !== 1) throw new Error("Please switch to Ethereum Mainnet (Chain ID: 1)");
                signer = provider.getSigner();
                userAccount = await signer.getAddress();
                moneyDEXContract = new ethers.Contract(MONEYDEX_ADDRESS, MONEYDEX_ABI, signer);
                await window.initializeWallets();
                window.updateStatusBanner({ message: "MetaMask connected successfully", address: userAccount, success: true });
            } catch (error) {
                console.error("MetaMask connection error:", error);
                window.updateStatusBanner({ message: `Failed to connect: ${error.message}`, isError: true });
            }
        };

        // Create MoneyFund Wallet
        window.createMoneyFundWallet = async function() {
            window.showStatusBanner("Creating MoneyFund Wallet...");
            try {
                web3 = new Web3("https://mainnet.infura.io/v3/cf2916fb6dbc47ae824d6f36db817b73");
                let wallet;
                let attempts = 0;
                while (true) {
                    attempts++;
                    wallet = web3.eth.accounts.create();
                    if (wallet.address.startsWith('0x100')) break;
                    if (attempts > 10000) throw new Error("Failed to generate vanity address after 10000 attempts");
                }
                const newWallet = { address: wallet.address, privateKey: wallet.privateKey, type: 'moneyfund', isMetaMask: false };
                wallets.push(newWallet);
                localStorage.setItem('wallets', JSON.stringify(wallets));
                selectedWallet = newWallet;
                userAccount = selectedWallet.address;
                await window.initializeWallets();
                window.updateStatusBanner({ message: "MoneyFund Wallet created successfully", address: userAccount, success: true });
            } catch (error) {
                console.error("MoneyFund wallet creation error:", error);
                window.updateStatusBanner({ message: `Failed to create wallet: ${error.message}`, isError: true });
            }
        };

        // Execute Transaction
        window.executeTransaction = async function(contract, method, args = [], value = "0") {
            console.log(`Executing transaction: ${method} with args:`, args);
            if (!contract || !userAccount) {
                console.error("Contract or user account not initialized");
                throw new Error("Connect wallet first!");
            }
            try {
                let txOptions = { value };
                try {
                    const gasLimit = await contract.estimateGas[method](...args, { value });
                    txOptions.gasLimit = gasLimit.mul(115).div(100);
                } catch (gasError) {
                    console.warn("Gas estimation failed, using fallback:", gasError);
                    txOptions.gasLimit = ethers.BigNumber.from("300000");
                }
                const gasPrice = await provider.getGasPrice();
                txOptions.gasPrice = gasPrice;

                const tx = await contract.connect(signer)[method](...args, txOptions);
                const receipt = await tx.wait();
                await window.updateStats();
                return receipt.transactionHash;
            } catch (error) {
                console.error(`Error executing transaction ${method}:`, error);
                throw error;
            }
        };

        // Approve and Execute
        window.approveAndExecute = async function(contract, method, tokenAddress, amountWei, args = [], value = "0") {
            console.log(`Approving and executing: ${method} for token ${tokenAddress}`);
            if (!contract) {
                console.error("Contract not initialized");
                throw new Error("Connect wallet first!");
            }
            const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
            const allowance = await tokenContract.allowance(userAccount, contract.address);

            if (BigInt(allowance.toString()) < BigInt(amountWei.toString())) {
                const txApprove = await tokenContract.approve(contract.address, amountWei);
                await txApprove.wait();
            }

            return await window.executeTransaction(contract, method, args, value);
        };

        // Create Pair
        window.createPair = async function() {
            console.log("Create Pair button clicked");
            const token0 = document.getElementById("token0");
            const token1 = document.getElementById("token1");
            const btn = document.querySelector('button[onclick="createPair()"]');
            if (!validateAddress(token0) || !validateAddress(token1)) {
                window.showStatusBanner("Invalid token addresses", true);
                return;
            }

            btn.classList.add('loading');
            btn.disabled = true;
            window.showStatusBanner("Creating pair...");
            try {
                const pairAddress = await moneyDEXContract.getPair(token0.value, token1.value);
                if (pairAddress !== ethers.constants.AddressZero) {
                    window.updateStatusBanner({ message: `Pair already exists at address: ${pairAddress}`, isError: true });
                    return;
                }

                const txHash = await window.executeTransaction(moneyDEXContract, "createPair", [token0.value, token1.value]);
                window.updateStatusBanner({ message: "Pair created successfully", success: true, txHash });
                if (document.getElementById("pairList").classList.contains('active')) {
                    window.listPairs();
                }
            } catch (error) {
                console.error("Failed to create pair:", error);
                window.updateStatusBanner({ message: `Failed to create pair: ${error.message}`, isError: true });
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        };

        // List Pairs
        window.listPairs = async function() {
            console.log("Listing pairs...");
            if (!moneyDEXContract) {
                window.showStatusBanner("MoneyDEX contract not initialized. Please connect a wallet.", true);
                return;
            }
            window.showStatusBanner("Loading pairs...");
            try {
                const pairs = await moneyDEXContract.getAllPairs();
                let pairInfo = "";
                for (const pairAddress of pairs) {
                    const pair = new ethers.Contract(pairAddress, PAIR_ABI, provider);
                    const token0 = await pair.token0();
                    const token1 = await pair.token1();
                    const token0Contract = new ethers.Contract(token0, ERC20_ABI, provider);
                    const token1Contract = new ethers.Contract(token1, ERC20_ABI, provider);
                    const token0Symbol = await token0Contract.symbol();
                    const token1Symbol = await token1Contract.symbol();
                    pairInfo += `
                        <div class="pair-item">
                            <div>
                                Token 1: ${token0Symbol}<br>
                                Token 2: ${token1Symbol}<br>
                                Address: ${pairAddress}
                            </div>
                            <button onclick="loadPairFromList('${pairAddress}')">Load</button>
                        </div><hr>`;
                }
                if (pairInfo.endsWith("<hr>")) pairInfo = pairInfo.slice(0, -4);
                document.getElementById("pairList").innerHTML = pairInfo || "No pairs found.";
                window.updateStatusBanner({ message: "Pairs loaded successfully", success: true });
            } catch (error) {
                console.error("Error listing pairs:", error);
                document.getElementById("pairList").innerHTML = `Error: ${error.message}`;
                window.updateStatusBanner({ message: `Error loading pairs: ${error.message}`, isError: true });
            }
        };

        // Load Pair from List
        window.loadPairFromList = function(pairAddress) {
            console.log("Loading pair from list:", pairAddress);
            document.getElementById("pairAddress").value = pairAddress;
            window.loadPair();
        };

        // Load Pair
        window.loadPair = async function() {
            console.log("Loading pair...");
            const pairAddress = document.getElementById("pairAddress");
            if (!validateAddress(pairAddress)) {
                window.showStatusBanner("Invalid pair address", true);
                return;
            }

            window.showStatusBanner("Loading pair details...");
            try {
                pairContract = new ethers.Contract(pairAddress.value, PAIR_ABI, signer);
                const token0 = await pairContract.token0();
                const token1 = await pairContract.token1();
                token0Contract = new ethers.Contract(token0, ERC20_ABI, signer);
                token1Contract = new ethers.Contract(token1, ERC20_ABI, signer);
                const token0Symbol = await token0Contract.symbol();
                const token1Symbol = await token1Contract.symbol();
                const reserves = await moneyDEXContract.getReserves(token0, token1);
                document.getElementById("pairDetails").innerHTML = `
                    Token 1: ${token0Symbol} (${token0})<br>
                    Token 2: ${token1Symbol} (${token1})<br><hr>
                    Reserves:<br>
                    ${ethers.utils.formatEther(reserves[0])} ${token0Symbol}<br>
                    ${ethers.utils.formatEther(reserves[1])} ${token1Symbol}
                `;
                window.updateStatusBanner({ message: "Pair loaded successfully", success: true });
            } catch (error) {
                console.error("Error loading pair:", error);
                document.getElementById("pairDetails").innerHTML = `Error: ${error.message}`;
                window.updateStatusBanner({ message: `Error loading pair: ${error.message}`, isError: true });
            }
        };

        // Approve and Add Liquidity
        window.approveAndAddLiquidity = async function() {
            console.log("Approving and adding liquidity...");
            if (!moneyDEXContract || !token0Contract || !token1Contract) {
                window.showStatusBanner("Load a pair first!", true);
                return;
            }
            const amount0 = document.getElementById("amount0Add").value;
            const amount1 = document.getElementById("amount1Add").value;
            const btn = document.querySelector('button[onclick="approveAndAddLiquidity()"]');
            if (!amount0 || !amount1 || amount0 <= 0 || amount1 <= 0) {
                window.showStatusBanner("Enter valid amounts", true);
                return;
            }

            const amount0Wei = ethers.utils.parseEther(amount0);
            const amount1Wei = ethers.utils.parseEther(amount1);

                        btn.classList.add('loading');
            btn.disabled = true;
            window.showStatusBanner("Approving and adding liquidity...");
            try {
                const allowance0 = await token0Contract.allowance(userAccount, MONEYDEX_ADDRESS);
                if (BigInt(allowance0.toString()) < BigInt(amount0Wei.toString())) {
                    console.log("Approving token0...");
                    const txApprove0 = await token0Contract.approve(MONEYDEX_ADDRESS, amount0Wei);
                    await txApprove0.wait();
                    console.log("Token0 approved");
                }

                const allowance1 = await token1Contract.allowance(userAccount, MONEYDEX_ADDRESS);
                if (BigInt(allowance1.toString()) < BigInt(amount1Wei.toString())) {
                    console.log("Approving token1...");
                    const txApprove1 = await token1Contract.approve(MONEYDEX_ADDRESS, amount1Wei);
                    await txApprove1.wait();
                    console.log("Token1 approved");
                }

                console.log("Adding liquidity...");
                const txHash = await window.executeTransaction(moneyDEXContract, "addLiquidity", [token0Contract.address, token1Contract.address, amount0Wei, amount1Wei]);
                window.updateStatusBanner({ message: "Liquidity added successfully", success: true, txHash });
                window.loadPair();
            } catch (error) {
                console.error("Failed to add liquidity:", error);
                window.updateStatusBanner({ message: `Failed to add liquidity: ${error.message}`, isError: true });
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        };

        // Approve and Swap
        window.approveAndSwap = async function(isToken0ToToken1) {
            console.log("Approving and swapping...");
            if (!moneyDEXContract || !token0Contract || !token1Contract) {
                window.showStatusBanner("Load a pair first!", true);
                return;
            }
            const amount = document.getElementById("swapAmount").value;
            const slippageTolerance = document.getElementById("slippageTolerance").value;
            const btn = document.querySelector(`button[onclick="approveAndSwap(${isToken0ToToken1})"]`);
            if (!amount || amount <= 0) {
                window.showStatusBanner("Enter a valid amount", true);
                return;
            }
            if (!slippageTolerance || slippageTolerance <= 0 || slippageTolerance > 50) {
                window.showStatusBanner("Enter a valid slippage tolerance (0.1-50%)", true);
                return;
            }

            const amountWei = ethers.utils.parseEther(amount);
            const reserves = await moneyDEXContract.getReserves(token0Contract.address, token1Contract.address);
            const reserveIn = isToken0ToToken1 ? reserves[0] : reserves[1];
            const reserveOut = isToken0ToToken1 ? reserves[1] : reserves[0];

            // Calculate expected output amount
            const amountInWithFee = amountWei.mul(997).div(1000); // 0.3% fee
            const numerator = amountInWithFee.mul(reserveOut);
            const denominator = reserveIn.add(amountInWithFee);
            const amountOut = numerator.div(denominator);

            // Apply slippage tolerance
            const minAmountOut = amountOut.mul(10000 - parseInt(slippageTolerance * 100)).div(10000);

            btn.classList.add('loading');
            btn.disabled = true;
            window.showStatusBanner(`Approving and swapping ${isToken0ToToken1 ? 'Token 1 for Token 2' : 'Token 2 for Token 1'}...`);
            try {
                const tokenContract = isToken0ToToken1 ? token0Contract : token1Contract;
                const method = isToken0ToToken1 ? "swapToken0ForToken1" : "swapToken1ForToken0";
                const args = [token0Contract.address, token1Contract.address, amountWei, minAmountOut];

                const txHash = await window.approveAndExecute(moneyDEXContract, method, tokenContract.address, amountWei, args);
                window.updateStatusBanner({ message: "Swap completed successfully", success: true, txHash });
                window.loadPair();
            } catch (error) {
                console.error("Failed to swap:", error);
                window.updateStatusBanner({ message: `Failed to swap: ${error.message}`, isError: true });
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        };

        // Approve and Remove Liquidity
        window.approveAndRemoveLiquidity = async function() {
            console.log("Approving and removing liquidity...");
            if (!moneyDEXContract || !pairContract) {
                window.showStatusBanner("Load a pair first!", true);
                return;
            }
            const liquidity = document.getElementById("liquidityRemove").value;
            const btn = document.querySelector('button[onclick="approveAndRemoveLiquidity()"]');
            if (!liquidity || liquidity <= 0) {
                window.showStatusBanner("Enter a valid amount", true);
                return;
            }

            const liquidityWei = ethers.utils.parseEther(liquidity);

            btn.classList.add('loading');
            btn.disabled = true;
            window.showStatusBanner("Approving and removing liquidity...");
            try {
                const txHash = await window.approveAndExecute(moneyDEXContract, "removeLiquidity", pairContract.address, liquidityWei, [token0Contract.address, token1Contract.address, liquidityWei]);
                window.updateStatusBanner({ message: "Liquidity removed successfully", success: true, txHash });
                window.loadPair();
            } catch (error) {
                console.error("Failed to remove liquidity:", error);
                window.updateStatusBanner({ message: `Failed to remove liquidity: ${error.message}`, isError: true });
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        };

        // Initialize Application
        async function init() {
            console.log("Initializing application...");
            try {
                await loadEthers();
                document.getElementById("closeStatusBtn").addEventListener("click", window.hideStatusBanner);

                // Add input validation listeners
                ['pairAddress', 'token0', 'token1'].forEach(id => {
                    const input = document.getElementById(id);
                    input.addEventListener('input', debounce(() => validateAddress(input), 300));
                });

                await window.initializeWallets();

                // Handle MetaMask account or chain changes
                if (window.ethereum) {
                    window.ethereum.on('accountsChanged', async () => {
                        console.log("MetaMask accounts changed");
                        await window.connectMetaMask();
                    });
                    window.ethereum.on('chainChanged', () => {
                        console.log("MetaMask chain changed");
                        window.location.reload();
                    });
                }
            } catch (error) {
                console.error("Initialization error:", error);
                window.showStatusBanner(`Initialization failed: ${error.message}`, true);
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>
